#! /bin/bash

export today=$(date "+%Y-%m-%d" 2>/dev/null)
export ymd=$(echo "$today" | tr '-' '_')

password="$1"

function print_header()
{
    cat <<EOF
                                 TEST_NAME   COMMITTED        STATUS
--------------------------------------------------------------------
EOF
}

function download_html_file()
{

    [ ! -d "$ymd" ] && mkdir "$ymd"

    test_name="$1"
    html_file="$ymd/$(basename $test_name .sh).html"


    wget \
        --user=pipas \
        --password="$password" \
        --no-check-certificate \
        "https://89.133.67.120/ft_install/?page=test&test_name=$test_name" \
        --output-document=$html_file 2>/dev/null

    git_date=$(cat $html_file | grep "^p42di 120" | awk '{print $3}')
    status=$(cat $html_file | grep "^p42di 110" | awk '{print $3}')

    printf "%42s " "$test_name"
    printf "%12s " "$git_date"
    printf "%12s " "$status"

    if [ "$git_date" != "$today" ]; then
        rm -f $html_file
        printf "NOT TODAY\n"
        return 0
    fi

    printf "\n"
}

function test_names()
{
    cat <<EOF
ft_access.sh 
ft_acl.sh 
ft_adminuser.sh 
ft_cat.sh 
ft_cdt.sh 
EOF
}

tests=$(test_names);

print_header
for testname in $tests; do
    download_html_file "$testname"
done

tar czf "${ymd}.tar.gz" "$ymd"
